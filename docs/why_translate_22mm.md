# なぜ translate((0, -25, 22)) なのか

## 結論
垂直板の配置には `.translate((0, -25, 22))` が必要です。

## 要件ベースの詳細説明

### 1. 仕様要件

#### 1.1 L字ブラケットの仕様（形状・寸法）
- **水平板**: 80mm x 50mm x 2mm (板厚)
- **垂直板**: 80mm x 40mm x 2mm (板厚)
- **L字形状**: 90度曲げ
- **座標系**:
  - 原点: 水平板中心底面
  - Z軸: 高さ方向（0〜42mm）

#### 1.2 グローバル座標系での目標配置
```
水平板: X=[-40, 40], Y=[-25, 25], Z=[0, 2]
垂直板: X=[-40, 40], Y=[-25, -23], Z=[2, 42]
                                      ↑
                        水平板の上端Z=2から垂直に立つ
```

---

### 2. 実装の流れと座標変換

#### ステップ1: 垂直板の初期状態（回転前）

```python
v_plate = cq.Workplane("XY").box(80, 40, 2, centered=(True, True, False))
```

**座標**:
- X: [-40, 40]
- Y: [-20, 20]  ← 高さ40mmをY方向に配置
- Z: [0, 2]     ← 板厚2mm

**要件との対応**:
- box()の第2引数40 = 垂直板の高さ40mm
- Z方向は板厚のみ

---

#### ステップ2: X軸周りに-90度回転

```python
.rotate((0, 0, 0), (1, 0, 0), -90)
```

**回転の数学的定義**:

X軸周りの回転行列（-90度）:
```
[1    0         0    ]
[0  cos(-90°) -sin(-90°)]
[0  sin(-90°)  cos(-90°)]

= [1   0    0]
  [0   0    1]
  [0  -1    0]
```

**座標変換の公式**:
```
X' = X
Y' = Y * cos(-90°) - Z * sin(-90°) = Y * 0 - Z * (-1) = Z
Z' = Y * sin(-90°) + Z * cos(-90°) = Y * (-1) + Z * 0 = -Y
```

**回転後の座標計算**:

元の座標 → 回転後:
- Y=[-20, 20] → Z'=[-(-20), -(20)] = **Z'=[-20, 20]**
- Z=[0, 2]    → Y'=[0, 2]

**回転後の座標**:
- X: [-40, 40]
- Y: [0, 2]      ← 元のZ座標がY座標になる（板厚2mm）
- Z: [-20, 20]   ← 元のY座標が-Z座標になる（高さ40mm）

**重要な観察**:
- 垂直板は**Z方向の中心が0**（Z: -20〜20）
- これは上下対称に配置されている
- 目標はZ: 2〜42なので、**下端を2mmに持ち上げる必要がある**

---

#### ステップ3: 必要な移動量の計算

##### 3.1 Y方向の移動量

**現在**: Y: [0, 2]
**目標**: Y: [-25, -23]

**計算**:
```
移動量ΔY = 目標の下端 - 現在の下端
        = (-25) - 0
        = -25 mm
```

##### 3.2 Z方向の移動量

**現在**: Z: [-20, 20]
**目標**: Z: [2, 42]

**計算**:
```
移動量ΔZ = 目標の下端 - 現在の下端
        = 2 - (-20)
        = 22 mm
```

**物理的な意味**:
- 現在、垂直板の下端はZ=-20（水平板より20mm下）
- 目標では、垂直板の下端はZ=2（水平板の上端）
- したがって、**22mm上に持ち上げる**必要がある

---

### 3. 移動量の内訳分析

#### 3.1 Z方向の22mmの内訳

```
22mm = 20mm + 2mm
       ↑      ↑
       ①      ②
```

**① 20mm**: 垂直板の中心を原点に合わせる
- 回転後、垂直板の中心はZ=0
- 垂直板の高さは40mm → 下端はZ=-20
- 中心をZ=0に保つため、下端をZ=0に持ち上げるには20mm必要

**② 2mm**: 水平板の厚さ分だけ上に配置
- 水平板の上端はZ=2
- L字形状にするため、垂直板の下端を水平板の上端に配置
- したがって、さらに2mm上に移動

**数式での表現**:
```
ΔZ = (垂直板の高さ / 2) + 水平板の厚さ
   = (40 / 2) + 2
   = 20 + 2
   = 22 mm
```

---

### 4. 一般化された公式

#### パラメータ定義
```python
t = 2.0                 # 板厚
vertical_height = 40.0  # 垂直板の高さ
horizontal_depth = 50.0 # 水平板の奥行き
```

#### translate()の一般式
```python
.translate((
    0,                          # X方向: 移動なし
    -(horizontal_depth / 2),   # Y方向: 水平板の後端に配置
    (vertical_height / 2) + t   # Z方向: 中心補正 + 水平板の厚さ
))

= .translate((0, -25, 22))
```

---

### 5. 検証: なぜ他の値では駄目なのか

#### 5.1 translate((0, -25, 0)) - 現在の実装
```
回転後: Z=[-20, 20]
移動後: Z=[-20, 20] + 0 = [-20, 20]
結果: ❌ T字形状（水平板の下に20mm伸びている）
```

#### 5.2 translate((0, -25, 2)) - 水平板の厚さのみ
```
回転後: Z=[-20, 20]
移動後: Z=[-20, 20] + 2 = [-18, 22]
結果: ❌ まだ水平板の下に18mm伸びている
```

#### 5.3 translate((0, -25, 20)) - 中心補正のみ
```
回転後: Z=[-20, 20]
移動後: Z=[-20, 20] + 20 = [0, 40]
結果: ❌ 垂直板の下端がZ=0（水平板に埋まっている）
```

#### 5.4 translate((0, -25, 22)) - 正しい値
```
回転後: Z=[-20, 20]
移動後: Z=[-20, 20] + 22 = [2, 42]
結果: ✅ L字形状（垂直板が水平板の上に立っている）
```

---

### 6. 要件との整合性確認

#### 6.1 バウンディングボックス
| 軸 | 実際の値 | 要件 | 判定 |
|----|---------|------|------|
| X  | [-40, 40] | [-40, 40] | ✅ |
| Y  | [-25, 25] | [-25, 25] | ✅ |
| Z  | [2, 42]   | [0, 42]   | ⚠️ |

**注**: Z最小値は水平板の下端(0)ではなく垂直板の下端(2)から始まる
→ union後は水平板も含まれるのでZ: [0, 42]になる

#### 6.2 L字形状の定義
```
L字 = 水平板 ∪ 垂直板
    = Z:[0, 2] ∪ Z:[2, 42]
    = Z:[0, 42]  ✅
```

---

### 7. コード修正箇所

#### 現在のコード (l_bracket_camera_mount.py:87)
```python
vertical_plate = (
    cq.Workplane("XY")
    .box(vertical_width, vertical_height, t, centered=(True, True, False))
    .rotate((0, 0, 0), (1, 0, 0), -90)
    .translate((0, -horizontal_depth/2, 0))  # ← 誤り
)
```

#### 修正後のコード
```python
vertical_plate = (
    cq.Workplane("XY")
    .box(vertical_width, vertical_height, t, centered=(True, True, False))
    .rotate((0, 0, 0), (1, 0, 0), -90)
    .translate((0, -horizontal_depth/2, vertical_height/2 + t))  # ← 正しい
)
```

---

### 8. まとめ

#### なぜ22mmなのか
1. **回転によるZ座標の変化**: 垂直板の高さ40mmが回転後にZ:[-20, 20]に分散
2. **中心補正**: 下端をZ=0に持ち上げるには20mm必要
3. **水平板との接続**: 水平板の上端(Z=2)に配置するには、さらに2mm必要
4. **合計**: 20mm + 2mm = **22mm**

#### 一般式
```
Z移動量 = (垂直板の高さ / 2) + 水平板の厚さ
```

#### 仕様要件との整合
- ✅ L字形状（90度曲げ）
- ✅ 一体構造
- ✅ バウンディングボックス: Z=[0, 42]
- ✅ 水平板の上に垂直板が立つ

---

## 参考: 他の実装方法との比較

### 方法A: centered=(True, True, True)を使う
```python
.box(80, 40, 2, centered=(True, True, True))  # Z方向も中心化
.rotate((0, 0, 0), (1, 0, 0), -90)
.translate((0, -25, 1 + 20))  # t/2 + vertical_height/2 = 1 + 20 = 21

# 結果: Z=[-1, 41] → union後 Z=[0, 41] ❌ (Z最大値が1mm不足)
```

### 方法B: 回転の中心を変更
```python
.box(80, 40, 2, centered=(True, True, False))
.rotate((0, 0, 20), (1, 0, 0), -90)  # Z=20を中心に回転
# → 複雑で分かりにくい
```

### 推奨: 現在の方法（方法C）
```python
.box(80, 40, 2, centered=(True, True, False))
.rotate((0, 0, 0), (1, 0, 0), -90)
.translate((0, -25, 22))
# → シンプルで理解しやすい
```

---

**作成日**: 2025-11-17
**目的**: translate((0, -25, 22))の理論的根拠を要件ベースで説明
