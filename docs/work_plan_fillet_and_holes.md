# L字ブラケット フィレット・穴位置修正 作業計画書

**日付:** 2025年11月17日（続き）
**作業セッション:** フィレット実装・穴位置補正
**ディレクトリ:** `/home/user/openscad_sandbox`

---

## 1. 判明した問題

### 問題1: L字内側角のフィレット（R）が適用されていない

**現象:**
- ブラケットが非常に角ばっている
- フィレット適用コードは存在するが、内側フィレットが失敗
- エラーメッセージ: `BRep_API: command not done`

**検証結果:**
```
✗ 内側フィレット失敗: BRep_API: command not done
✓ 外側フィレット適用成功: R1.5mm
```

**エッジ情報:**
- フィレットなし: 総エッジ数 33
- フィレット付き: 総エッジ数 39（外側のみ適用）
- 内側角エッジセレクタ: `|X and >Z and <Y` → 1エッジ選択されているが失敗

**考えられる原因:**
1. エッジセレクタが間違っている（正しいエッジを選択していない）
2. union後のトポロジーが複雑で、選択されたエッジにフィレットが適用できない
3. フィレット半径 R3.0mm が大きすぎる（板厚2mm、隙間不足）
4. 穴がエッジに近すぎてフィレット失敗

---

### 問題2: カメラ穴の位置が低すぎる

**現象:**
- 4つのカメラ穴が「L字の角の方に着ていて本来よりも低い」
- 現在の位置: Z=10mm, Z=18mm（角から8mm, 16mm）

**現在の実装:**
```python
camera_z_bottom = t + 8.0   # 2 + 8 = 10mm
camera_z_top = t + 16.0     # 2 + 16 = 18mm
```

**問題点:**
- 仕様が不明確（正しい位置がわからない）
- L字の角（Z=2mm）からの距離が近すぎる可能性
- フィレットを適用すると、さらに穴とフィレットが干渉する可能性

---

### 問題3: verifyコードが散らかっている

**現象:**
- ルートディレクトリに複数の検証スクリプトが散在
- `verify_camera_holes_position.py`
- `verify_fillet_status.py`
- 出力ディレクトリ: `outputs/verify_camera_holes/`, `outputs/verify_fillet/`

---

## 2. 作業計画（フェーズ別）

### 【フェーズ1】カメラ穴位置の仕様確認と修正（15分）

**目的:** カメラ穴の正しい位置を特定し、修正する

#### 1.1 仕様確認（5分）
- [ ] テストファイルやドキュメントから仕様を読み取る
- [ ] 現在の位置を視覚的に確認（DXF断面）
- [ ] ユーザーに正しい位置を確認（必要に応じて）

**想定仕様候補:**
- 下端から10mm, 18mm → 下端から15mm, 25mm?
- 下端から10mm, 18mm → 下端から12mm, 20mm?
- グローバル座標で明確に指定されている可能性

#### 1.2 穴位置検証スクリプト作成（5分）
- [ ] 現在の穴位置を視覚化
- [ ] 複数の候補位置をDXFで比較
- [ ] フィレットとの干渉チェック

**成果物:**
- `verify_camera_hole_position.py`（改良版）
- DXF比較画像

#### 1.3 穴位置修正（5分）
- [ ] 仕様に基づいて座標を修正
- [ ] テスト実行
- [ ] DXFで位置確認

---

### 【フェーズ2】フィレット実装の修正（30分）

**目的:** L字内側角のフィレット（R3.0mm）を正しく適用する

#### 2.1 エッジデバッグスクリプト作成（10分）
- [ ] 全エッジの位置・方向・タイプを解析
- [ ] L字内側角のエッジを特定
- [ ] 複数のセレクタ候補をテスト

**デバッグ項目:**
```python
# 全エッジを列挙
for i, edge in enumerate(bracket.edges().vals()):
    - エッジタイプ（Line/Circle/Ellipse/Spline）
    - 始点・終点座標
    - 方向ベクトル
    - 長さ
```

**セレクタ候補:**
```python
# 現在（失敗）
"|X and >Z and <Y"

# 候補1: 位置ベース
"|(0, -25, 2) and |X"

# 候補2: 複数条件
"(>Z[-0.1:2.1] and <Y[-26:-24]) or (|X and >Z[1:3] and <Y[-26:-24])"

# 候補3: 手動選択
edges().vals()[specific_index]
```

**成果物:**
- `debug_edges.py`
- エッジリストレポート（テキスト）

#### 2.2 フィレット実装方針の決定（5分）

**方針A: エッジセレクタを改良**
- 利点: コードがシンプル
- 欠点: セレクタが複雑になる可能性

**方針B: 手動エッジ選択**
- 利点: 確実に正しいエッジを選択できる
- 欠点: パラメータ変更時に脆い

**方針C: フィレット半径を調整**
- R3.0mm → R2.0mm or R1.5mm
- 利点: 干渉リスク低減
- 欠点: 仕様を変更することになる

**方針D: 穴を開ける前にフィレット適用**
- 利点: トポロジーがシンプル
- 欠点: 実装順序の大幅な変更が必要

#### 2.3 フィレット実装（10分）
- [ ] 選択した方針で実装
- [ ] フィレット適用
- [ ] エラーハンドリング追加

#### 2.4 検証とDXF確認（5分）
- [ ] フィレット付きモデル生成
- [ ] DXF断面でR形状確認
- [ ] エッジ数・タイプの変化確認
- [ ] テスト実行

**期待結果:**
```
✓ 内側フィレット適用成功: R3.0mm (または調整後の値)
✓ 外側フィレット適用成功: R1.5mm
```

---

### 【フェーズ3】統合テストと出力確認（10分）

#### 3.1 仕様テスト実行（3分）
- [ ] `tests/test_l_bracket_requirements.py` 実行
- [ ] 全テストPASS確認

#### 3.2 出力ファイル再生成（4分）
- [ ] STEP/STL/SCAD生成
- [ ] ファイルサイズ確認
- [ ] DXF断面生成（3方向）

#### 3.3 視覚的確認（3分）
- [ ] DXFファイルで形状確認
- [ ] L字の角にRが付いているか
- [ ] カメラ穴位置が正しいか
- [ ] 全体のバウンディングボックス

---

### 【フェーズ4】verifyコード整理（15分）

#### 4.1 ディレクトリ構造整理（5分）
- [ ] `tests/verify/` ディレクトリ作成
- [ ] 既存verifyスクリプトを移動
- [ ] `.gitignore` 更新

**移動対象:**
```
verify_camera_holes_position.py → tests/verify/
verify_fillet_status.py → tests/verify/
debug_edges.py → tests/verify/
```

#### 4.2 統合検証スクリプト作成（10分）
- [ ] `tests/verify/run_all_verifications.py` 作成
- [ ] 全検証を一括実行
- [ ] サマリーレポート生成

**内容:**
```python
#!/usr/bin/env python3
"""統合検証スクリプト"""

def main():
    print("=== L字ブラケット 統合検証 ===")

    # 1. 形状検証
    run_shape_verification()

    # 2. 穴位置検証
    run_hole_position_verification()

    # 3. フィレット検証
    run_fillet_verification()

    # 4. 仕様テスト
    run_requirements_test()

    # サマリー出力
    print_summary()
```

---

### 【フェーズ5】ドキュメント更新とコミット（10分）

#### 5.1 作業記録更新（5分）
- [ ] workdocに詳細記録
- [ ] 躓きポイント記録
- [ ] 新しい根本原因の記録

#### 5.2 コミット・プッシュ（5分）
- [ ] git status確認
- [ ] コミットメッセージ作成
- [ ] プッシュ

---

## 3. 作業時間見積

| フェーズ | 見積時間 | 内容 |
|---------|---------|------|
| フェーズ1 | 15分 | カメラ穴位置の仕様確認と修正 |
| フェーズ2 | 30分 | フィレット実装の修正 |
| フェーズ3 | 10分 | 統合テストと出力確認 |
| フェーズ4 | 15分 | verifyコード整理 |
| フェーズ5 | 10分 | ドキュメント更新とコミット |
| **合計** | **80分** | |

---

## 4. リスクと対策

### リスク1: フィレット適用が技術的に困難
**対策:**
- フィレット半径を小さくする（R3.0 → R2.0 → R1.5）
- 最悪の場合、フィレットなしで進める（仕様要件次第）

### リスク2: カメラ穴の正しい仕様が不明
**対策:**
- ユーザーに直接確認
- 複数候補を生成して選択してもらう

### リスク3: フィレットと穴が干渉
**対策:**
- 穴位置を調整
- フィレット半径を調整
- 実装順序を変更（フィレット→穴開け）

---

## 5. 成功基準

### 必須（Must）
- [ ] L字内側角にフィレット（R）が適用されている
- [ ] カメラ穴が正しい位置にある
- [ ] 全仕様テストがPASS
- [ ] DXFでL字の角がR形状になっている

### 推奨（Should）
- [ ] verifyコードが整理されている
- [ ] 統合検証スクリプトが動作する
- [ ] 作業記録が完全

### オプション（Nice to have）
- [ ] 外側エッジにも追加のフィレット
- [ ] 複数のフィレット半径候補を生成

---

## 6. 次のアクション

**まず実行:**
1. カメラ穴位置の仕様確認（テストファイル・ドキュメント調査）
2. エッジデバッグスクリプト作成・実行
3. フィレット実装方針決定

**ユーザー確認が必要な項目:**
- カメラ穴の正しい位置（Z座標）
- フィレット半径の許容範囲（R3.0が必須か、調整可能か）

---
